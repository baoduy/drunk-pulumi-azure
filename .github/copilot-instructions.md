# Drunk Pulumi Azure - GitHub Copilot Instructions

Always reference these instructions first and fallback to search or bash commands only when you encounter unexpected information that does not match the info here.

## Repository Overview

Drunk Pulumi Azure is a TypeScript-based library that provides a set of tools and utilities for managing Azure resources using Pulumi. It uses a builder pattern to create and configure Azure infrastructure components including VMs, Key Vaults, Storage Accounts, Application Insights, and Azure Active Directory resources.

## Working Effectively

### Prerequisites and Dependencies
- **Node.js**: Version 20 (confirmed working version: v20.19.4)
- **Package Manager**: pnpm version 8 (install with `npm install -g pnpm@8`)
- **Build Time**: Allow adequate time - builds can take 30+ seconds

### Essential Setup and Build Commands
Run these commands in sequence for first-time setup:

```bash
# Install pnpm globally if not already installed
npm install -g pnpm@8

# Install dependencies - NEVER CANCEL, takes 2+ minutes
pnpm install

# Full build process - NEVER CANCEL, takes ~30 seconds  
pnpm run build

# Verify build succeeded
ls -la .out-bin/
```

**CRITICAL TIMING WARNINGS:**
- `pnpm install` takes 2+ minutes - NEVER CANCEL. Set timeout to 5+ minutes.
- `pnpm run build` takes ~30 seconds - NEVER CANCEL. Set timeout to 2+ minutes.
- `pnpm run ciBuild` takes ~15 seconds (faster CI build)

### Build System Details
- **Full Build**: `pnpm run build` - Runs update-tsconfig, fastBuild, and copy-pkg
- **CI Build**: `pnpm run ciBuild` - Faster build for CI (runs fastBuild only)
- **Output Directory**: `.out-bin/` - Contains compiled JS, TypeScript definitions, and clean package.json
- **TypeScript Config**: Auto-generated by `.tasks/update-tsconfig.ts` (scans src/ directory)

### Testing
```bash
# Run working tests (many tests are outdated)
npx cross-env TS_NODE_PROJECT='./tsconfig.test.json' mocha --timeout 10000 -r ts-node/register 'src/z_tests/Common/Helpers.test.ts'

# Test specific functionality
npx cross-env TS_NODE_PROJECT='./tsconfig.test.json' mocha --timeout 10000 -r ts-node/register 'src/z_tests/Vnet/Helper.test.ts'
```

**Testing Notes:**
- Many test files in `src/z_tests/` are outdated and reference missing modules
- Working tests include: `Helpers.test.ts`, `Vnet/Helper.test.ts`
- Test timeout: 10 seconds per test
- **DO NOT** attempt to fix all broken tests - focus on functionality that actually works

### Linting and Code Quality
```bash
# Run ESLint - shows ~150 warnings but doesn't fail build
pnpm run lint
```

**Linting Notes:**
- Takes ~10 seconds to complete
- Shows many TypeScript warnings but this is normal for this codebase
- ESLint configuration fixed to use dynamic path resolution
- Required dependencies: @typescript-eslint/eslint-plugin, @typescript-eslint/parser, @eslint/js, @eslint/eslintrc, eslint-plugin-deprecation

### Package Creation and Distribution
```bash
# Create distributable package
pnpm run pack

# Verify package creation
ls -la .out-bin/*.tgz
```

## Validation

### Manual Functionality Testing
Always validate that core functionality works after making changes:

```bash
# Test built package functionality
node -e "
const helpers = require('./.out-bin/Common/Helpers.js');
console.log('Testing getRootDomainFromUrl:');
console.log(helpers.getRootDomainFromUrl('test.drunkcoding.net'));
console.log('Testing RangeOf:');
console.log(helpers.RangeOf(3));
"
```

Expected output:
```
Testing getRootDomainFromUrl:
drunkcoding.net
Testing RangeOf:
[ 0, 1, 2 ]
```

### Build Validation Steps
1. **ALWAYS** run `pnpm install` first when working with fresh clone
2. **ALWAYS** run `pnpm run build` before testing changes
3. **ALWAYS** test core functionality after building
4. **ALWAYS** run `pnpm run lint` before committing (warnings are expected)

### CI/CD Validation
The repository has a GitHub Actions workflow (`.github/workflows/build-publish-drunk.yml`) that:
- Uses Node.js 20 and pnpm 8
- Runs `pnpm run build`
- Creates releases and publishes to npm
- **NEVER CANCEL** these builds - they can take several minutes

## Repository Structure

### Key Directories and Files
```
src/
├── Aks/           # Azure Kubernetes Service utilities
├── AzAd/          # Azure Active Directory utilities  
├── Builder/       # Builder pattern implementations
├── Cdn/           # CDN utilities
├── Certificate/   # Certificate management
├── Common/        # Common utilities and helpers
├── Core/          # Core functionality
├── CustomRoles/   # Custom role definitions
├── KeyVault/      # Key Vault utilities
├── Logs/          # Application Insights and Log Analytics
├── Monitor/       # Monitoring utilities
├── Sql/           # SQL database utilities
├── Storage/       # Storage account utilities
├── VNet/          # Virtual Network utilities
├── VirtualMachine/ # VM utilities
├── env.ts         # Environment utilities
├── index.ts       # Main exports
├── types.ts       # Type definitions
└── z_tests/       # Test files (many outdated)

.out-bin/          # Build output (generated)
.tasks/            # Build scripts
docs/              # Documentation
pulumi-test/       # Example Pulumi project
```

### Important Files
- `package.json` - Dependencies and scripts
- `tsconfig.json` - TypeScript configuration (auto-generated)
- `tsconfig.test.json` - Test-specific TypeScript config
- `eslint.config.mjs` - ESLint configuration
- `.tasks/update-tsconfig.ts` - Script that auto-generates tsconfig.json
- `.tasks/npm-package.ts` - Script that creates clean package.json for distribution

## Common Tasks

### Working with the Builder Pattern
This library uses a builder pattern for creating Azure resources:

```typescript
import { ResourceBuilder, StorageBuilder } from '@drunk-pulumi/azure';

// Example usage from pulumi-test/index.ts
const rs = await ResourceBuilder('az-test')
  .createRoles()
  .createRG({ enableVaultRoles: true })
  .createVault('az-test-vault')
  .build();
```

### Key Builder Classes
- `ResourceBuilder` - Base resource builder
- `StorageBuilder` - Storage account builder
- `VaultBuilder` - Key Vault builder
- `AksBuilder` - AKS cluster builder
- `ApimBuilder` - API Management builder
- And many more in `src/Builder/`

### Development Workflow
1. Make changes to TypeScript files in `src/`
2. Run `pnpm run build` (updates tsconfig.json automatically)
3. Test functionality with working test files
4. Verify package builds with `pnpm run pack`
5. Run `pnpm run lint` (expect warnings)

### Pulumi Testing
Use the `pulumi-test/` directory for testing Pulumi functionality:
- Contains example usage of the library
- Uses local package reference: `"@drunk-pulumi/azure": "file:/../.out-bin"`
- Has its own package.json with Pulumi scripts

## Known Issues and Workarounds

### Test Suite Issues
- Many tests in `src/z_tests/` reference outdated modules
- **DO NOT** attempt to fix all broken tests
- Focus on tests that actually work: `Common/Helpers.test.ts`, `Vnet/Helper.test.ts`

### ESLint Configuration
- Configuration previously had hardcoded developer path (now fixed)
- Shows ~150 warnings but this is normal for this codebase
- Warnings do not prevent successful builds

### Build Dependencies
- Requires specific versions: Node.js 20, pnpm 8
- Build process auto-generates tsconfig.json from source files
- Uses cross-env for environment variables (Windows compatibility)

## Performance Expectations

### Command Timing (NEVER CANCEL these operations)
- `pnpm install`: 2+ minutes (dependency download)
- `pnpm run build`: ~30 seconds (full build with tsconfig update)
- `pnpm run ciBuild`: ~15 seconds (CI build, faster)
- `pnpm run lint`: ~10 seconds
- `pnpm run pack`: <1 second
- Individual tests: ~6 seconds

### Memory Requirements
- Build process uses `NODE_OPTIONS=--max-old-space-size=4096`
- Large TypeScript project with ~200 source files
- May require increased Node.js memory limits

## Package Information
- **Name**: @drunk-pulumi/azure
- **Type**: TypeScript library for Pulumi
- **Target**: Azure infrastructure management
- **Distribution**: npm package (published from GitHub Actions)
- **Dependencies**: Pulumi, Azure SDKs, TypeScript utilities